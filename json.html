<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
    <title>Retrieve JSON from Parse.com</title>

</head>

<body>  
	<h1>JSON</h1>
  <div class="campuses">
    <form role="form">
      <div>
        <select class="form-control" id="campus">
          <option value="boston">Boston</option>
          <option value="grafton">Grafton</option>
          <option value="medford">Medford/Somerville</option>
        </select>
      </div>
      <div>
        <h2>Filters</h2>
        <p>*If both exclude &amp; include tags present, both criterias must be met.</p>
        <div class="form-group">
          <label>Exlude locations with tags:</label>
          <div>
            <input id="tagExclude" type="text" placeholder="example: tag1, tag2, tag3" />
          </div>
        </div>
        <div class="form-group">
          <label>Include locations with tags:</label>
          <div>
            <input id="tagInclude" type="text" placeholder="example: tag1, tag2, tag3" />
          </div>
        </div>
      </div>
      <div>
        <button type="button" id="get-data" class="btn btn-default">Get Data</button>
      </div>
    </form>
  </div>

	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
	<script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.5.2/underscore-min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/underscore.string/2.3.3/underscore.string.min.js"></script>
	<script src="//www.parsecdn.com/js/parse-1.2.9.min.js"></script>
	 
	<script type="text/javascript">
		$(function() {

			var query, campusid, utils;

      utils = {

          filter: filter

      };

      _.mixin(_.str.exports());

			Parse.initialize("nfmwDYABTXjDPTOmfBvz89Fe3i7Sv8lp426R2Fzu", "2wMHizUh1Y73nMjmHDIdIJVMd7aUPI7V4r1eUSTh");

      $("body").on( "click", "#get-data", function() {
        
        campusid = $("#campus :selected").val();

        fetch( campusid );

      });

      function fetch(campus) {

        new Parse.Query('Campus')

                 .equalTo("campusid", campusid)
                  
                 // Include nested object data in instead of just pointers to object ids
                 .include('maps.locations')

                 .find({
                  
                    success: handleSuccess,
                    
                    error: handleError

                 });
/*
        new Parse.Query('Location')

                 .equalTo("campus", campus)

                 .limit(1000) // Default is 100, max is 1000

                 .find({
                  
                    success: handleSuccess,
                    
                    error: handleError

                 });
*/                 
      }

      function filter(list) {

        var tagsExclude = convertTxtToItems( $("#tagExclude").val() ),

            tagsInclude = convertTxtToItems( $("#tagInclude").val() );

        console.log('filter before', list.length);

        return _.chain(list)

                .map(function(loc) { loc.tagItems = convertTxtToItems(loc.get('tags')); return loc; })

                .reject(function(loc) { 

                  if (_.isEmpty(tagsExclude)) return false;

                  return _.intersection(loc.tagItems, tagsExclude).length > 0; 

                })

                .filter(function(loc) { 

                  if (_.isEmpty(tagsInclude)) return true;

                  return _.intersection(loc.tagItems, tagsInclude).length > 0; 

                })

                .value();
      }

			function handleError() {

				console.log('handleError');

			}

			function handleSuccess(results) {

        var campus = _.first(results), // The campus

            map = campus && _.first(campus.get('maps')), // The map

            locations = utils.filter(map && map.get('locations')),

            json;

        if (!(campus && map)) return;

        //map.fetch()

        //.then(function() {

          json = campus.toJSON();

          json.maps[0] = map.toJSON();

          json.maps[0].locations = _.map(locations, function(loc) { return loc.toJSON(); });

          //console.log('map json', map.toJSON());

          console.log('filter after', locations.length);

          console.log('json', JSON.stringify(json));

        //});

			}

      function convertTxtToItems(txt) {

        txt || (txt = '');

        return _.chain(txt.split(','))

                .map(function(item) { return _.trim(item); })

                .reject(function(item) { return _.isEmpty(txt); })

                .value();

      }


      function trim(txt) {

        return _.trim(txt);

      }

		});
	</script>
</body>
</html>
